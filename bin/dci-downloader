#!/usr/bin/env bash

function print_env_variables_missing {
    echo "DCI_CLIENT_ID, DCI_API_SECRET and DCI_CS_URL environment variables should be defined"
}

if [[ -z "${DCI_CLIENT_ID}" ]]; then
    print_env_variables_missing
    exit 1
fi

if [[ -z "${DCI_API_SECRET}" ]]; then
    print_env_variables_missing
    exit 1
fi

if [[ -z "${DCI_CS_URL}" ]]; then
    print_env_variables_missing
    exit 1
fi

DCI_LOCAL_REPO=${DCI_LOCAL_REPO:-"/var/lib/dci"}
if [ ! -d "${DCI_LOCAL_REPO}" ]; then
    mkdir -p ${DCI_LOCAL_REPO};
    if [ $? -ne 0 ] ; then
        exit 1
    fi
fi

podman run \
    --rm \
    -e DCI_CLIENT_ID \
    -e DCI_API_SECRET \
    -e DCI_CS_URL \
    -e DCI_LOCAL_REPO \
    -v ${DCI_LOCAL_REPO}:${DCI_LOCAL_REPO}:Z \
    quay.io/distributedci/dci-downloader:stable "$@"